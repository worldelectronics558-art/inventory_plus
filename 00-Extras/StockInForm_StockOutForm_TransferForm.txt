StockInForm.jsx
// src/pages/InventorySubPages/StockInForm.jsx

import React, { useState, useMemo, useEffect } from 'react';
import { useNavigate } from 'react-router-dom'; // Assuming you use React Router for navigation
import { useInventory } from '../../contexts/InventoryContext';
import { useProducts } from '../../contexts/ProductContext'; // Changed hook name
import { useLocations } from '../../contexts/LocationContext'; // NEW: Use LocationContext
import { useAuth } from '../../contexts/AuthContext';
import { useUser } from '../../contexts/UserContext';

// Helper function to get product details by SKU
const getProductBySku = (products, sku) => {
    return products.find(p => p.sku === sku);
};

// Helper function to get model display name
const getProductDisplayName = (product) => {
    if (product) {
        return `${product.sku} - ${product.model || 'N/A'}`;
    }
    return 'Unknown Product';
};

const StockInForm = () => {
    const navigate = useNavigate(); // Hook for navigation
    const { stockLevels, createTransaction } = useInventory();
    const { products } = useProducts(); // Changed hook name
    // NEW: Get locations and addLocation from LocationContext
    const { locations, locationNames, addLocation: rawAddLocation, isLoading: isLocationsLoading } = useLocations(); // Get locationNames array and addLocation function
    const { userId, currentUser: authUser } = useAuth(); // Get auth user object to get email
    const { assignedLocations: rawAssignedLocations } = useUser();

    const assignedLocations = rawAssignedLocations || []; // Ensure it's always an array

    // --- Form State ---
    const [referenceNumber, setReferenceNumber] = useState(''); // Will be generated on commit
    const [transactionDate, setTransactionDate] = useState(new Date().toISOString().split('T')[0]); // YYYY-MM-DD
    const [notes, setNotes] = useState('');
    const [documentNumber, setDocumentNumber] = useState('');
    const [items, setItems] = useState([{ sku: '', location: '', quantity: 1, reason: 'purchase' }]); // Initial empty line
    const [newLocationName, setNewLocationName] = useState('');
    const [addingLocation, setAddingLocation] = useState(false);

    // Calculate effective locations based on user permissions and current state
    const effectiveLocationNames = useMemo(() => {
        let locs = locationNames; // Start with all names from the context
        if (assignedLocations.length > 0) {
            // If user has assigned locations, filter the list
            locs = locs.filter(locName => assignedLocations.includes(locName));
        }
        if (addingLocation && newLocationName.trim()) {
            // If adding a new location, prepend it to the list for the dropdown
            locs = [newLocationName.trim(), ...locs];
        }
        return locs;
    }, [locationNames, assignedLocations, addingLocation, newLocationName]);

    // --- Generate Reference Number (Client-side, based on email prefix and timestamp) ---
    const generateReferenceNumber = (userEmail) => {
        const userPrefix = (userEmail || 'USER').slice(0, 4).toUpperCase();
        const now = new Date();
        const timestampPart = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
        return `${userPrefix}-IN-${timestampPart}`;
    };

    // --- Handle Item Changes ---
    const handleItemChange = (index, field, value) => {
        const newItems = [...items];
        newItems[index][field] = value;
        // If SKU or Location changes, update Current Qty
        if (field === 'sku' || field === 'location') {
            const product = getProductBySku(products, newItems[index].sku);
            // Use the location *from the specific item being changed* to calculate currentQty
            const currentQty = product ? (stockLevels[newItems[index].sku] || {})[newItems[index].location] || 0 : 0;
            newItems[index].currentQty = currentQty;
        }
        setItems(newItems);
    };

    const handleAddItem = () => {
        setItems([...items, { sku: '', location: '', quantity: 1, reason: 'purchase', currentQty: 0 }]);
    };

    const handleRemoveItem = (index) => {
        if (items.length <= 1) return; // Prevent removing the last item
        const newItems = [...items];
        newItems.splice(index, 1);
        setItems(newItems);
    };

    // --- Handle Location Creation ---
    const handleAddNewLocation = async () => {
        if (!newLocationName.trim()) {
            alert('Please enter a new location name.');
            return;
        }
        try {
            // Use the new addLocation function from LocationContext
            await rawAddLocation({ name: newLocationName }); // Pass as object
            setNewLocationName(''); // Clear input
            setAddingLocation(false); // Hide input
            // The LocationContext listener should update the locations list automatically
            alert(`Location "${newLocationName}" added successfully!`);
        } catch (error) {
            console.error("Failed to add new location:", error);
            alert(error.message);
        }
    };

    // --- Handle Form Submission ---
    const handleSubmit = async (e) => {
        e.preventDefault();

        // Validate form data
        if (items.some(item => !item.sku || !item.location || item.quantity <= 0)) {
            alert('Please fill in all SKU, Location, and Quantity fields correctly.');
            return;
        }

        // Generate reference number just before commit
        const refNumber = generateReferenceNumber(authUser?.email); // Use email from auth context

        try {
            // Prepare transaction data
            const transactionData = {
                type: 'IN',
                referenceNumber: refNumber, // Use generated number
                transactionDate: new Date(transactionDate), // Store as Date object or ISO string
                notes: notes,
                documentNumber: documentNumber,
                items: items.map(item => ({
                    sku: item.sku,
                    location: item.location, // Ensure location is part of the item
                    quantity: item.quantity,
                    reason: item.reason,
                    // currentQty is for display only, not stored in transaction
                })),
                userId: userId,
                // The serverTimestamp will be added by the context
            };

            console.log("Attempting to commit Stock In:", transactionData); // Debug log

            // Call context function to create transaction
            await createTransaction(transactionData);
            alert('Stock In transaction recorded successfully!');
            // Navigate back or reset form
            navigate('/inventory'); // Or reset state to clear form
        } catch (error) {
            console.error('Stock In failed:', error);
            alert(`Failed to record Stock In: ${error.message}`);
        }
    };

    // --- Reset Form Function ---
    const handleReset = () => {
        // Reset all form fields to their initial state
        setReferenceNumber(''); // Reference number will regenerate on next commit
        setTransactionDate(new Date().toISOString().split('T')[0]); // Reset to today
        setNotes('');
        setDocumentNumber('');
        setItems([{ sku: '', location: '', quantity: 1, reason: 'purchase' }]); // Reset to one empty line
        setNewLocationName(''); // Clear new location input
        setAddingLocation(false); // Hide add location input
        // No need to reset 'locations' state as it comes from context
    };

    // --- Render ---
    return (
        <div className="min-h-screen bg-gray-100 p-4">
            <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6">
                {/* Header */}
                <div className="flex justify-between items-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-800">Stock In</h1>
                    <div className="flex gap-2">
                        <button
                            onClick={handleReset} // Call the reset function
                            className="btn btn-outline-danger" // Use themed button
                        >
                            Reset
                        </button>
                        <button
                            onClick={() => navigate('/inventory')} // Navigate back
                            className="btn btn-outline-primary" // Use themed button
                            title='Go back to Inventory'
                        >
                            Back to Inventory
                        </button>
                    </div>
                </div>

                {/* Form Fields */}
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Reference Number</label>
                            <input
                                type="text"
                                value={referenceNumber || 'Will be generated on commit'}
                                readOnly
                                className="input-base bg-gray-100" // Use themed input, make readonly bg obvious
                            />
                        </div>

                        {/* Column 2: Transaction Date */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Transaction Date</label>
                            <input
                                type="date"
                                value={transactionDate}
                                onChange={(e) => setTransactionDate(e.target.value)}
                                className="input-base"
                            />
                        </div>

                        {/* Column 3: Document Number */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Document Number</label>
                            <input
                                type="text"
                                value={documentNumber}
                                onChange={(e) => setDocumentNumber(e.target.value)}
                                placeholder="Optional"
                                className="input-base"
                            />
                        </div>
                    </div>

                    {/* Notes (Full-width row) */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            rows="2" // Reduced rows for compactness
                            className="input-base"
                        />
                    </div>

                    {/* Item Lines Table */}
                    <div className="border border-gray-300 rounded-lg overflow-hidden">
                        <table className="table-base min-w-full">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Qty</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {items.map((item, index) => (
                                    <tr key={index} className="hover:bg-gray-50">
                                        {/* ... (Model select remains the same) ... */}
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <select
                                                value={item.sku}
                                                onChange={(e) => handleItemChange(index, 'sku', e.target.value)}
                                                className="w-full p-1 border border-gray-300 rounded"
                                            >
                                                <option value="">Select Model</option>
                                                {products.map(p => (
                                                    <option key={p.sku} value={p.sku}>{getProductDisplayName(p)}</option> // Use product.sku as key for options
                                                ))}
                                            </select>
                                        </td>
                                        {/* Location Select */}
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <div className="flex items-center">
                                                <select
                                                    value={item.location} // Bind to item.location
                                                    onChange={(e) => handleItemChange(index, 'location', e.target.value)} // Update item.location
                                                    className="flex-1 p-1 border border-gray-300 rounded"
                                                >
                                                    <option value="">Select Location</option>
                                                    {/* Iterate over the calculated effectiveLocationNames */}
                                                    {effectiveLocationNames.map(locName => {
                                                        // Find the corresponding location object to get its ID for the key
                                                        const locationObj = locations.find(loc => loc.name === locName);

                                                        // Determine the key
                                                        // If locationObj is found (it's a real location from the context), use its ID.
                                                        // If locationObj is not found (it's the temporary name being added), use a unique fallback key.
                                                        const key = locationObj ? locationObj.id : `temp_${index}_loc_${locName}`;

                                                        // Debug: Log if object is not found (should only happen for the temp name)
                                                        if (!locationObj) {
                                                            console.debug(`[StockInForm] Generating temp key for new location name: ${locName}, index: ${index}`);
                                                        }

                                                        return (
                                                            <option key={key} value={locName}>{locName}</option> // Use the determined unique key
                                                        );
                                                    })}
                                                </select>
                                                <button
                                                    type="button"
                                                    onClick={() => setAddingLocation(true)}
                                                    className="ml-1 px-2 py-1 btn btn-outline-secondary" // Use themed button
                                                >
                                                    +
                                                </button>
                                            </div>
                                            {addingLocation && index === items.length - 1 && ( // Show input only for the last row if adding
                                                <div className="mt-1 flex gap-1">
                                                    <input
                                                        type="text"
                                                        value={newLocationName}
                                                        onChange={(e) => setNewLocationName(e.target.value)}
                                                        placeholder="New Location Name"
                                                        className="flex-1 p-1 border border-gray-300 rounded"
                                                    />
                                                    <button
                                                        type="button"
                                                        onClick={handleAddNewLocation}
                                                        className="ml-1 px-2 py-1 btn btn-success" // Use themed button
                                                    >
                                                        Add
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => {
                                                            setAddingLocation(false);
                                                            setNewLocationName('');
                                                        }}
                                                        className="ml-1 px-2 py-1 btn btn-danger" // Use themed button
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            )}
                                        </td>
                                        {/* ... (Current Qty, Quantity, Reason, Action cells remain the same) ... */}
                                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                                            {item.currentQty || 0}
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <input
                                                type="number"
                                                value={item.quantity}
                                                onChange={(e) => handleItemChange(index, 'quantity', parseInt(e.target.value) || 0)}
                                                min="0"
                                                className="w-20 p-1 border border-gray-300 rounded"
                                            />
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <select
                                                value={item.reason}
                                                onChange={(e) => handleItemChange(index, 'reason', e.target.value)}
                                                className="w-full p-1 border border-gray-300 rounded"
                                            >
                                                <option value="purchase">Purchase</option>
                                                <option value="return">Return</option>
                                                <option value="adjustment">Adjustment</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap text-sm">
                                            <button
                                                type="button"
                                                onClick={() => handleRemoveItem(index)}
                                                className="btn btn-outline-danger btn-sm" // Use themed button, small size
                                            >
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <div className="flex justify-between">
                        <button
                            type="button"
                            onClick={handleAddItem}
                            className="btn btn-outline-primary" // Use themed button
                        >
                            + Add Line
                        </button>
                        <button
                            type="submit"
                            className="btn btn-primary" // Use themed button
                        >
                            Commit Stock In
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default StockInForm;


StockOutform.jsx
// src/pages/InventorySubPages/StockOutForm.jsx

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom'; // Assuming you use React Router for navigation
import { useInventory } from '../../contexts/InventoryContext';
import { useProducts } from '../../contexts/ProductContext'; // Changed hook name
import { useLocations } from '../../contexts/LocationContext'; // NEW: Use LocationContext
import { useAuth } from '../../contexts/AuthContext';
import { useUser } from '../../contexts/UserContext';

// Helper function to get product details by SKU
const getProductBySku = (products, sku) => {
    return products.find(p => p.sku === sku);
};

// Helper function to get model display name
const getProductDisplayName = (product) => {
    if (product) {
        return `${product.sku} - ${product.model || 'N/A'}`;
    }
    return 'Unknown Product';
};

const StockOutForm = () => {
    const navigate = useNavigate(); // Hook for navigation
    const { stockLevels, createTransaction } = useInventory();
    const { products } = useProducts(); // Changed hook name
    // Remove lookups usage
    // const { lookups, addLookupItem } = useLookups();
    // Add locations usage
    const { locations, addLocation: rawAddLocation } = useLocations(); // NEW: Use LocationContext
    const { userId, currentUser: authUser } = useAuth(); // Get auth user object to get email
    const { assignedLocations: rawAssignedLocations } = useUser();

    // Locations are now an array of objects: [{id, name, ...}]
    // Extract just the names for the dropdown
    const locationNames = locations.map(loc => loc.name);
    const assignedLocations = rawAssignedLocations || []; // Ensure it's always an array

    // --- Form State ---
    const [referenceNumber, setReferenceNumber] = useState(''); // Will be generated on commit
    const [transactionDate, setTransactionDate] = useState(new Date().toISOString().split('T')[0]); // YYYY-MM-DD
    const [notes, setNotes] = useState('');
    const [documentNumber, setDocumentNumber] = useState('');
    const [items, setItems] = useState([{ sku: '', location: '', quantity: 1, reason: 'sale' }]); // Initial empty line
    const [newLocationName, setNewLocationName] = useState('');
    const [addingLocation, setAddingLocation] = useState(false);

    // --- Generate Reference Number (Client-side, based on email prefix and timestamp) ---
    const generateReferenceNumber = (userEmail) => {
        const userPrefix = (userEmail || 'USER').slice(0, 4).toUpperCase();
        const now = new Date();
        const timestampPart = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
        return `${userPrefix}-OUT-${timestampPart}`;
    };

    // --- Handle Item Changes ---
    const handleItemChange = (index, field, value) => {
        const newItems = [...items];
        newItems[index][field] = value;
        // If SKU or Location changes, update Current Qty
        if (field === 'sku' || field === 'location') {
            const product = getProductBySku(products, value);
            const currentQty = product ? (stockLevels[newItems[index].sku] || {})[newItems[index].location] || 0 : 0;
            newItems[index].currentQty = currentQty;
        }
        setItems(newItems);
    };

    const handleAddItem = () => {
        setItems([...items, { sku: '', location: '', quantity: 1, reason: 'sale', currentQty: 0 }]);
    };

    const handleRemoveItem = (index) => {
        if (items.length <= 1) return; // Prevent removing the last item
        const newItems = [...items];
        newItems.splice(index, 1);
        setItems(newItems);
    };

    // --- Handle Location Creation ---
    const handleAddNewLocation = async () => {
        if (!newLocationName.trim()) {
            alert('Please enter a new location name.');
            return;
        }
        try {
            // Use the new addLocation function from LocationContext
            await rawAddLocation({ name: newLocationName }); // Pass as object
            setNewLocationName(''); // Clear input
            setAddingLocation(false); // Hide input
            // The LocationContext listener should update the locations list automatically
        } catch (error) {
            console.error("Failed to add new location:", error);
            alert(error.message);
        }
    };

    // --- Handle Form Submission ---
    const handleSubmit = async (e) => {
        e.preventDefault();

        // Validate form data
        if (items.some(item => !item.sku || !item.location || item.quantity <= 0)) {
            alert('Please fill in all SKU, Location, and Quantity fields correctly.');
            return;
        }

        // Optional: Validate sufficient stock
        for (const item of items) {
            const currentQty = (stockLevels[item.sku] || {})[item.location] || 0;
            if (currentQty < item.quantity) {
                alert(`Insufficient stock for SKU ${item.sku} at location ${item.location}. Requested: ${item.quantity}, Available: ${currentQty}`);
                return;
            }
        }

        // Generate reference number just before commit
        const refNumber = generateReferenceNumber(authUser?.email); // Use email from auth context

        try {
            // Prepare transaction data
            const transactionData = {
                type: 'OUT',
                referenceNumber: refNumber, // Use generated number
                transactionDate: new Date(transactionDate), // Store as Date object or ISO string
                notes: notes,
                documentNumber: documentNumber,
                items: items.map(item => ({
                    sku: item.sku,
                    location: item.location, // Ensure location is part of the item if needed by context
                    quantity: item.quantity,
                    reason: item.reason,
                    // currentQty is for display only, not stored in transaction
                })),
                userId: userId,
                // The serverTimestamp will be added by the context
            };

            console.log("Attempting to commit Stock Out:", transactionData); // Debug log

            // Call context function to create transaction
            await createTransaction(transactionData);
            alert('Stock Out transaction recorded successfully!');
            // Navigate back or reset form
            navigate('/inventory'); // Or reset state to clear form
        } catch (error) {
            console.error('Stock Out failed:', error);
            alert(`Failed to record Stock Out: ${error.message}`);
        }
    };

    // --- Calculate Available Locations for a specific item ---
    const getAvailableLocationsForItem = (itemIndex) => {
        // Get all location names
        let locs = locationNames;
        // Apply assigned locations filter if applicable
        if (assignedLocations.length > 0) {
            locs = locs.filter(locName => assignedLocations.includes(locName));
        }
        // Add the new location being created if in the process of adding
        if (addingLocation) {
            locs = [newLocationName, ...locs];
        }
        return locs;
    };

    // --- Render ---
    return (
        <div className="min-h-screen bg-gray-100 p-4">
            <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6">
                {/* Header */}
                <div className="flex justify-between items-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-800">Stock Out</h1>
                    <button
                        onClick={() => navigate('/inventory')} // Navigate back
                        className="btn btn-outline-primary"
                    >
                        Back to Inventory
                    </button>
                </div>

                {/* Form Fields */}
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Reference Number</label>
                            <input
                                type="text"
                                value={referenceNumber || 'Will be generated on commit'} // Show placeholder until commit
                                readOnly // Generated, not user-editable
                                className="input-base"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Transaction Date</label>
                            <input
                                type="date"
                                value={transactionDate}
                                onChange={(e) => setTransactionDate(e.target.value)}
                                className="input-base"
                            />
                        </div>
                        <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Document Number</label>
                        <input
                            type="text"
                            value={documentNumber}
                            onChange={(e) => setDocumentNumber(e.target.value)}
                            placeholder="Optional"
                            className="input-base"
                        />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            rows="1"
                            className="input-base"
                        />
                    </div>
                    

                    {/* Item Lines Table */}
                    <div className="border border-gray-300 rounded-lg overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Qty</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {items.map((item, index) => (
                                    <tr key={index} className="hover:bg-gray-50">
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <select
                                                value={item.sku}
                                                onChange={(e) => handleItemChange(index, 'sku', e.target.value)}
                                                className="w-full p-1 border border-gray-300 rounded"
                                            >
                                                <option value="">Select Model</option>
                                                {products.map(p => (
                                                    <option key={p.sku} value={p.sku}>{getProductDisplayName(p)}</option>
                                                ))}
                                            </select>
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <div className="flex items-center">
                                                <select
                                                    value={item.location} // Bind to item.location
                                                    onChange={(e) => handleItemChange(index, 'location', e.target.value)} // Update item.location
                                                    className="flex-1 p-1 border border-gray-300 rounded"
                                                >
                                                    <option value="">Select Location</option>
                                                    {getAvailableLocationsForItem(index).map(locName => (
                                                        <option key={locName} value={locName}>{locName}</option>
                                                    ))}
                                                </select>
                                                <button
                                                    type="button"
                                                    onClick={() => setAddingLocation(true)}
                                                    className="ml-1 px-2 py-1 btn btn-secondary"
                                                >
                                                    +
                                                </button>
                                            </div>
                                            {addingLocation && index === items.length - 1 && ( // Show input only for the last row if adding
                                                <div className="mt-1 flex gap-1">
                                                    <input
                                                        type="text"
                                                        value={newLocationName}
                                                        onChange={(e) => setNewLocationName(e.target.value)}
                                                        placeholder="New Location Name"
                                                        className="flex-1 p-1 border border-gray-300 rounded"
                                                    />
                                                    <button
                                                        type="button"
                                                        onClick={handleAddNewLocation}
                                                        className="px-2 py-1 btn btn-secondary"
                                                    >
                                                        Add
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => {
                                                            setAddingLocation(false);
                                                            setNewLocationName('');
                                                        }}
                                                        className="px-2 py-1 btn btn-danger"
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            )}
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                                            {item.currentQty || 0}
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <input
                                                type="number"
                                                value={item.quantity}
                                                onChange={(e) => handleItemChange(index, 'quantity', parseInt(e.target.value) || 0)}
                                                min="1"
                                                className="w-20 p-1 border border-gray-300 rounded"
                                            />
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <select
                                                value={item.reason}
                                                onChange={(e) => handleItemChange(index, 'reason', e.target.value)}
                                                className="w-full p-1 border border-gray-300 rounded"
                                            >
                                                <option value="sale">Sale</option>
                                                <option value="damage">Damage</option>
                                                <option value="adjustment">Adjustment</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap text-sm">
                                            <button
                                                type="button"
                                                onClick={() => handleRemoveItem(index)}
                                                className="px-2 btn btn-danger"
                                            >
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <div className="flex justify-between">
                        <button
                            type="button"
                            onClick={handleAddItem}
                            className="btn btn-outline-primary"
                        >
                            + Add Line
                        </button>
                        <button
                            type="submit"
                            className="btn btn-primary"
                        >
                            Commit Stock Out
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default StockOutForm;

TransferForm.jsx
// src/pages/InventorySubPages/TransferForm.jsx

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom'; // Assuming you use React Router for navigation
import { useInventory } from '../../contexts/InventoryContext';
import { useProducts } from '../../contexts/ProductContext'; // Changed hook name
import { useLocations } from '../../contexts/LocationContext'; // NEW: Use LocationContext
import { useAuth } from '../../contexts/AuthContext';
import { useUser } from '../../contexts/UserContext';

// Helper function to get product details by SKU
const getProductBySku = (products, sku) => {
    return products.find(p => p.sku === sku);
};

// Helper function to get model display name
const getProductDisplayName = (product) => {
    if (product) {
        return `${product.sku} - ${product.model || 'N/A'}`;
    }
    return 'Unknown Product';
};

const TransferForm = () => {
    const navigate = useNavigate(); // Hook for navigation
    const { stockLevels, createTransaction } = useInventory();
    const { products } = useProducts(); // Changed hook name
    // Remove lookups usage
    // const { lookups, addLookupItem } = useLookups();
    // Add locations usage
    const { locations, addLocation: rawAddLocation } = useLocations(); // NEW: Use LocationContext
    const { userId, currentUser: authUser } = useAuth(); // Get auth user object to get email
    const { assignedLocations: rawAssignedLocations } = useUser();

    // Locations are now an array of objects: [{id, name, ...}]
    // Extract just the names for the dropdown
    const locationNames = locations.map(loc => loc.name);
    const assignedLocations = rawAssignedLocations || []; // Ensure it's always an array

    // --- Form State ---
    const [referenceNumber, setReferenceNumber] = useState(''); // Will be generated on commit
    const [transactionDate, setTransactionDate] = useState(new Date().toISOString().split('T')[0]); // YYYY-MM-DD
    const [notes, setNotes] = useState('');
    const [documentNumber, setDocumentNumber] = useState('');
    const [items, setItems] = useState([{ sku: '', fromLocation: '', toLocation: '', quantity: 1 }]); // Initial empty line
    const [newFromLocationName, setNewFromLocationName] = useState('');
    const [newToLocationName, setNewToLocationName] = useState('');
    const [addingFromLocation, setAddingFromLocation] = useState(false);
    const [addingToLocation, setAddingToLocation] = useState(false);

    // --- Generate Reference Number (Client-side, based on email prefix and timestamp) ---
    const generateReferenceNumber = (userEmail) => {
        const userPrefix = (userEmail || 'USER').slice(0, 4).toUpperCase();
        const now = new Date();
        const timestampPart = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
        return `${userPrefix}-TRF-${timestampPart}`;
    };

    // --- Handle Item Changes ---
    const handleItemChange = (index, field, value) => {
        const newItems = [...items];
        newItems[index][field] = value;
        // If SKU or From Location changes, update Current Qty
        if (field === 'sku' || field === 'fromLocation') {
            const product = getProductBySku(products, newItems[index].sku);
            const currentQty = product ? (stockLevels[newItems[index].sku] || {})[newItems[index].fromLocation] || 0 : 0;
            newItems[index].currentQty = currentQty;
        }
        setItems(newItems);
    };

    const handleAddItem = () => {
        setItems([...items, { sku: '', fromLocation: '', toLocation: '', quantity: 1, currentQty: 0 }]);
    };

    const handleRemoveItem = (index) => {
        if (items.length <= 1) return; // Prevent removing the last item
        const newItems = [...items];
        newItems.splice(index, 1);
        setItems(newItems);
    };

    // --- Handle Location Creation ---
    const handleAddNewFromLocation = async () => {
        if (!newFromLocationName.trim()) {
            alert('Please enter a new "From" location name.');
            return;
        }
        try {
            // Use the new addLocation function from LocationContext
            await rawAddLocation({ name: newFromLocationName }); // Pass as object
            setNewFromLocationName(''); // Clear input
            setAddingFromLocation(false); // Hide input
            // The LocationContext listener should update the locations list automatically
        } catch (error) {
            console.error("Failed to add new 'From' location:", error);
            alert(error.message);
        }
    };

    const handleAddNewToLocation = async () => {
        if (!newToLocationName.trim()) {
            alert('Please enter a new "To" location name.');
            return;
        }
        try {
            // Use the new addLocation function from LocationContext
            await rawAddLocation({ name: newToLocationName }); // Pass as object
            setNewToLocationName(''); // Clear input
            setAddingToLocation(false); // Hide input
            // The LocationContext listener should update the locations list automatically
        } catch (error) {
            console.error("Failed to add new 'To' location:", error);
            alert(error.message);
        }
    };

    // --- Handle Form Submission ---
    const handleSubmit = async (e) => {
        e.preventDefault();

        // Validate form data
        if (items.some(item => !item.sku || !item.fromLocation || !item.toLocation || item.quantity <= 0 || item.fromLocation === item.toLocation)) {
            alert('Please fill in all SKU, From Location, To Location, and Quantity fields correctly. "From" and "To" locations must be different.');
            return;
        }

        // Optional: Validate sufficient stock
        for (const item of items) {
            const currentQty = (stockLevels[item.sku] || {})[item.fromLocation] || 0;
            if (currentQty < item.quantity) {
                alert(`Insufficient stock for SKU ${item.sku} at "From" location ${item.fromLocation}. Requested: ${item.quantity}, Available: ${currentQty}`);
                return;
            }
        }

        // Generate reference number just before commit
        const refNumber = generateReferenceNumber(authUser?.email); // Use email from auth context

        try {
            // Prepare transaction data
            const transactionData = {
                type: 'TRANSFER',
                referenceNumber: refNumber, // Use generated number
                transactionDate: new Date(transactionDate), // Store as Date object or ISO string
                notes: notes,
                documentNumber: documentNumber,
                items: items.map(item => ({
                    sku: item.sku,
                    fromLocation: item.fromLocation,
                    toLocation: item.toLocation,
                    quantity: item.quantity,
                    // currentQty is for display only, not stored in transaction
                })),
                userId: userId,
                // The serverTimestamp will be added by the context
            };

            console.log("Attempting to commit Transfer:", transactionData); // Debug log

            // Call context function to create transaction
            await createTransaction(transactionData);
            alert('Transfer transaction recorded successfully!');
            // Navigate back or reset form
            navigate('/inventory'); // Or reset state to clear form
        } catch (error) {
            console.error('Transfer failed:', error);
            alert(`Failed to record Transfer: ${error.message}`);
        }
    };

    // --- Calculate Available Locations for a specific item ---
    const getAvailableLocationsForItem = (itemIndex, type) => { // type is 'from' or 'to'
        // Get all location names
        let locs = locationNames;
        if (type === 'from' && assignedLocations.length > 0) {
            // For "From" location, restrict to assigned locations if any exist
            locs = locs.filter(locName => assignedLocations.includes(locName));
        }
        // "To" location is unrestricted by default for now
        if (type === 'from' && addingFromLocation) {
            locs = [newFromLocationName, ...locs];
        }
        if (type === 'to' && addingToLocation) {
            locs = [newToLocationName, ...locs];
        }
        return locs;
    };

    // --- Render ---
    return (
        <div className="min-h-screen bg-gray-100 p-4">
            <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6">
                {/* Header */}
                <div className="flex justify-between items-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-800">Transfer</h1>
                    <button
                        onClick={() => navigate('/inventory')} // Navigate back
                        className="btn btn-outline-primary"
                    >
                        Back to Inventory
                    </button>
                </div>

                {/* Form Fields */}
                <form onSubmit={handleSubmit} className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Reference Number</label>
                            <input
                                type="text"
                                value={referenceNumber || 'Will be generated on commit'} // Show placeholder until commit
                                readOnly // Generated, not user-editable
                                className="input-base"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Transaction Date</label>
                            <input
                                type="date"
                                value={transactionDate}
                                onChange={(e) => setTransactionDate(e.target.value)}
                                className="input-base"
                            />
                        </div>
                        <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Document Number</label>
                        <input
                            type="text"
                            value={documentNumber}
                            onChange={(e) => setDocumentNumber(e.target.value)}
                            placeholder="Optional"
                            className="input-base"
                        />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            rows="1"
                            className="input-base"
                        />
                    </div>
                    

                    {/* Item Lines Table */}
                    <div className="border border-gray-300 rounded-lg overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">From Location</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To Location</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Qty</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {items.map((item, index) => (
                                    <tr key={index} className="hover:bg-gray-50">
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <select
                                                value={item.sku}
                                                onChange={(e) => handleItemChange(index, 'sku', e.target.value)}
                                                className="w-full p-1 border border-gray-300 rounded"
                                            >
                                                <option value="">Select Model</option>
                                                {products.map(p => (
                                                    <option key={p.sku} value={p.sku}>{getProductDisplayName(p)}</option>
                                                ))}
                                            </select>
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <div className="flex items-center">
                                                <select
                                                    value={item.fromLocation} // Bind to item.fromLocation
                                                    onChange={(e) => handleItemChange(index, 'fromLocation', e.target.value)} // Update item.fromLocation
                                                    className="flex-1 p-1 border border-gray-300 rounded"
                                                >
                                                    <option value="">Select From</option>
                                                    {getAvailableLocationsForItem(index, 'from').map(locName => (
                                                        <option key={locName} value={locName}>{locName}</option>
                                                    ))}
                                                </select>
                                                <button
                                                    type="button"
                                                    onClick={() => setAddingFromLocation(true)}
                                                    className="ml-1 px-2 py-1 btn btn-secondary"
                                                >
                                                    +
                                                </button>
                                            </div>
                                            {addingFromLocation && index === items.length - 1 && ( // Show input only for the last row if adding
                                                <div className="mt-1 flex gap-1">
                                                    <input
                                                        type="text"
                                                        value={newFromLocationName}
                                                        onChange={(e) => setNewFromLocationName(e.target.value)}
                                                        placeholder="New From Location"
                                                        className="flex-1 p-1 border border-gray-300 rounded"
                                                    />
                                                    <button
                                                        type="button"
                                                        onClick={handleAddNewFromLocation}
                                                        className="px-2 py-1 btn btn-secondary"
                                                    >
                                                        Add
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => {
                                                            setAddingFromLocation(false);
                                                            setNewFromLocationName('');
                                                        }}
                                                        className="px-2 py-1 btn btn-danger"
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            )}
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <div className="flex items-center">
                                                <select
                                                    value={item.toLocation} // Bind to item.toLocation
                                                    onChange={(e) => handleItemChange(index, 'toLocation', e.target.value)} // Update item.toLocation
                                                    className="flex-1 p-1 border border-gray-300 rounded"
                                                >
                                                    <option value="">Select To</option>
                                                    {getAvailableLocationsForItem(index, 'to').map(locName => (
                                                        <option key={locName} value={locName}>{locName}</option>
                                                    ))}
                                                </select>
                                                <button
                                                    type="button"
                                                    onClick={() => setAddingToLocation(true)}
                                                    className="ml-1 px-2 py-1 btn btn-secondary"
                                                >
                                                    +
                                                </button>
                                            </div>
                                            {addingToLocation && index === items.length - 1 && ( // Show input only for the last row if adding
                                                <div className="mt-1 flex gap-1">
                                                    <input
                                                        type="text"
                                                        value={newToLocationName}
                                                        onChange={(e) => setNewToLocationName(e.target.value)}
                                                        placeholder="New To Location"
                                                        className="flex-1 p-1 border border-gray-300 rounded"
                                                    />
                                                    <button
                                                        type="button"
                                                        onClick={handleAddNewToLocation}
                                                        className="px-2 py-1 btn btn-secondary"
                                                    >
                                                        Add
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => {
                                                            setAddingToLocation(false);
                                                            setNewToLocationName('');
                                                        }}
                                                        className="px-2 py-1 btn btn-danger"
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            )}
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                                            {item.currentQty || 0}
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <input
                                                type="number"
                                                value={item.quantity}
                                                onChange={(e) => handleItemChange(index, 'quantity', parseInt(e.target.value) || 0)}
                                                min="1"
                                                className="w-20 p-1 border border-gray-300 rounded"
                                            />
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap text-sm">
                                            <button
                                                type="button"
                                                onClick={() => handleRemoveItem(index)}
                                                className="px-2 py-1 btn btn-danger"
                                            >
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <div className="flex justify-between">
                        <button
                            type="button"
                            onClick={handleAddItem}
                            className="btn btn-outline-primary"
                        >
                            + Add Line
                        </button>
                        <button
                            type="submit"
                            className="btn btn-primary"
                        >
                            Commit Transfer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default TransferForm;